---
title : "Manipuler des données avec `data.table`"
subtitle : "Atelier __`utilitR`__"
author : "Lino Galiana"
institute : "Insee"
date : "`r format(Sys.time(), '%d %B %Y')`"
output:
  utilitr::utilitr_presentation:
    new_session: yes
    css: ../custom.css
    includes:
      after_body: ../insert-logo.html
    self_contained: true
    lib_dir: "public"
---

# Introduction

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

.sauterligne[
Voici les recommandations de [la fiche](https://www.book.utilitr.org/datatable.html#datatable) :
.small90[
.indent[
.recommandation[
* Pour des tables de données de taille petite et moyenne (inférieure à 1 Go ou moins d'un million d'observations), il est recommandé d'utiliser le package `dplyr` ;
* Pour des tables de données de grande taille (plus de 1 Go ou plus d'un million d'observations), il est recommandé d'utiliser le package `data.table` qui fait l'objet de la présente fiche.
]
]
]
]

* Tous les exemples présentés sont reproductibles sur une instance [![SSPcloud](https://img.shields.io/badge/SSPcloud-Tester%20via%20SSP--cloud-informational?logo=R)](https://datalab.sspcloud.fr/launcher/inseefrlab-helm-charts-datascience/rstudio?onyxia.friendlyName=%C2%ABrstudio-utilitr%C2%BB&init.personnalInit=%C2%ABhttps%3A%2F%2Fraw.githubusercontent.com%2FInseeFrLab%2FutilitR%2Fmaster%2Fresources%2Finit_9juin.sh%C2%BB&r.version=%C2%ABinseefrlab%2Futilitr%3A0.7.0%C2%BB)
* Certains exemples de cette présentation utilisent les données disponibles dans le package `doremifasolData` ; vous ne pourrez reproduire ces exemples que si ce package est installé sur la machine sur laquelle vous travaillez (cf. [Comment utiliser la documentation utilitR](https://www.book.utilitr.org/presentation-utilitr.html#presentation-utilitr) )

---
.sauterligne2[
Plan de la présentation :
]

- Présentation de `data.table` ;
- Manipuler des données avec `data.table`: principe ;
- Manipuler des données avec `data.table`: illustration ;
- L'opérateur `:=`: késako ? ;
- Programmer des fonctions avec `data.table`.


---
# Présentation de `data.table`
## Principes structurants

* Package existant depuis 2006
    + L'un des plus utilisés: +700k téléchargements par mois sur le CRAN
    + 3000 packages sur le CRAN en dépendent plus ou moins directement
* Très pérenne, très robuste mais en évolution permanente
    + Ne dépend que de R-base (aucune autre dépendance)
    + Grosse communauté de développeurs : plus de 100 contributeurs sur Github [Github](https://github.com/Rdatatable/data.table)
    + Enormément de tests pour fiabiliser les évolutions (taux couverture : 99%)

```{r, echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/Rdatatable/data.table/master/.graphics/logo.png")
```

---
# Présentation de `data.table`
## Pourquoi `data.table` ?

* Package beaucoup plus rapide que `tidyverse`
* Optimise l'usage mémoire: avantageux pour les grosses données
* Package stable: peu de risques que le code casse
* Enormément de fonctions pré-implémentées
* Programmation et automatisation avec des fonctions facile
* Codes concis ce qui rend un code plus lisible et facilite ses évolutions

`data.table` n'est pas réservé aux grosses données ou aux utilisateurs avancés ! 


---
# Présentation de `data.table`
## Tout se passe dans les crochets `[...]`

* `data.table` un package dont l'objet central est le... `data.table`
* version améliorée du `data.frame` de base : le `data.table`
* syntaxe particulière associée à cette évolution: tout se passe dans les crochets: `[...]`
* très inspiré par SQL

```{r, echo = FALSE}
knitr::include_graphics("https://linogaliana.netlify.app/img/headers/datatable.png")
```

> on part du `data.table` `DT`, on sélectionne certaines lignes avec `i`, puis on calcule `j` pour chaque groupe défini par `by`. Si on fait un parallèle avec `SQL`, `i` correspond au `WHERE`, `j` au `SELECT` et `by` au `GROUP BY`

---
# Présentation de `data.table`
## Premier jeu de données d'exemple

Avant de travailler sur données réelles, un jeu de données d'exemple 

```{r}
dt <- data.table(x = c("A", "B", "C"),
                 y = 1:12,
                 z = 3:6)
dt
```

---
# Présentation de `data.table`
## Tout se passe dans les crochets `[...]`

* `R base`: les crochets `df[...]` servent uniquement à sélectionner des lignes ou des colonnes
* `data.table`: crochets permettent de tout faire
    + pas nécessaire d'utiliser le préfixe `DT$` pour se référer aux variables à l'intérieur de `[...]`
    + apporte concision, donc lisibilité
    + optimisé: réduit le temps de traitement des données car ne manipule que les colonnes mentionnées
    
Exemple: on veut calculer la moyenne de `y` par groupe défini par `x`, uniquement sur les observations pour lesquelles `x` est supérieur à 3

<table class='table' style = "width : 70%;">
<tr> <td>**`Base R`**</td> 
<td>
```{r, eval=FALSE}
aggregate(
  dt[dt[["x"]] > 3]$y,
  by = list(dt[dt[["x"]] > 3]$z),
  FUN = sum)
```
</td>
</tr>
<tr>
<td>**`dplyr`**</td> 
<td>
```{r, eval=FALSE}
dt %>%
  dplyr::filter(x > 3) %>%
  dplyr::group_by(z) %>%
  dplyr::summarise(sum(y))
```
</td>
</tr>
<tr>
<td>**`data.table`**</td> 
<td>
```{r, eval=FALSE}

dt[x > 3, sum(y), by = z]
```
</td>
</tr>
</table>

</div>

---
# Manipuler des données avec `data.table`: principe ;
## Enchaîner des opérations

* il suffit d'accoler les opérateurs `[...]`

Exemple: moyenne d'une variable par groupe, puis on trie la table.

```{r}
# En chaînant
ans <- dt[ , .(moyenne = mean(y, na.rm = TRUE)), by = x][order(moyenne)]
ans
```


---
# Remerciements


<!-- Le projet `utilitR` est un projet collaboratif qui a bénéficié des contributions de :  -->
<!-- r paste0(paste(format(Filter(function(x) !("cph" %in% x$role), desc::desc_get_authors()), include = c("given", "family")), collapse = ", "), ".") -->

.small90[
.auteurs[

Contributeurs : Raphaële Adjerad, Mathias André, Pierre-Yves Berrard, Lionel Cacheux, Arthur Cazaubiel, Sylvain Daubrée, Arlindo Dos Santos, Alexis Eidelman, Marie-Emmanuelle Faure, Gilles Fidani, Lino Galiana, Gaëlle Genin, Pierre Lamarche, Claire Legroux, Romain Lesur, Jean-Daniel Lomenède, Pascal Mercier, Olivier Meslin, Géraldine Rochambeau, Milena Suarez Castillo, Cédric Tassart.

Coordination : Lino Galiana et Olivier Meslin.

Comité de parrainage : Arnaud Degorre, Benoît Rouppert, Patrick Sillard et Sébastien Roux pour leur soutien.

Logo : Anna Schlaifer.

Les contributeurs remercient Julien Taquet et Marc Hufschmitt pour leur aide précieuse sur la mise en forme du site et de la brochure.
]
]

---
background-image: url('resources/logo-utilitr.png')
background-size: 7cm
background-position: 8.5cm 3cm

# Merci !


