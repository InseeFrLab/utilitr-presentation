---
title : Utiliser des paquets<br/>Choisir ses paquets<br/>Gérer ses dépendances
author : "Romain Lesur"
institute : "Insee"
date : "7 juin 2021"
output:
  xaringan::moon_reader:
    new_session: yes
    self_contained: false
    css:
    - css/default.css
    - css/default-fonts.css
    - css/style-utilitr.css
    - css/icones-fa.css
    - css/metropolis.css
    - css/customize-slides.css
    - custom.css
    includes:
      after_body: insert-logo.html
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
# Bienvenue !

Cet atelier va couvrir les fiches : 

.sauterligne3[
- [Utiliser des packages R](https://www.book.utilitr.org/utiliser-packages.html) (fiche n° 9)
- [Comment choisir un package ?](https://www.book.utilitr.org/choisir-package.html) (fiche n° 10)
- [Gérer les dépendances](https://www.book.utilitr.org/gerer-dependances.html) (fiche n° 11)
]

---

# Introduction

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

R tout seul ?  

--

Il sait déjà faire beaucoup de choses

--

Mais il peut faire bien plus grâce aux paquets (_packages_)

--

.sauterligne2[
  Plan de la présentation :
]

- Partie 1: installer et gérer une bibliothèque de paquets
- Partie 2: pourquoi utiliser des paquets et comment les choisir ?
- Partie 3: gérer ses dépendances avec `renv` 
- Partie 4: gérer ses dépendances avec un fichier `DESCRIPTION`

---

# Au fait, c'est quoi un paquet ?

Du code publié par quelqu'un...

--

...que vous pouvez facilement installer et utiliser

--

## Comment est-ce que ça fonctionne en pratique ?

--

Le CRAN :

- les auteurs envoient leurs paquets au CRAN
- les responsables du CRAN font quelques contrôles
- les responsables du CRAN les publient

--

Existe-t-il des paquets qui ne sont pas sur le CRAN ?

- un auteur peut publier son paquet sur internet
- vous l'installez à vos risques et périls...
- ...mais nous allons voir comment nous repérer

---

# Installer un paquet

```{r, eval=FALSE}
install.packages("monBeauPackage")
```


.remarque[
* Attention aux majuscules et minuscules
* Cette commande installe le paquet et ses dépendances
* Cette installation est définitive
* Permet de mettre à jour le paquet
]

.recommandation[
* Ne pas mettre `install.packages()` dans ses programmes
* Utiliser une des méthodes qui suivront pour gérer les dépendances de son projet 
]

---

# Parcourir ses bibliothèques dans RStudio


---

# Utiliser un paquet

## Charger l'ensemble des fonctions proposées par un package

```{r, eval=FALSE}
library(ggplot2)
```

--

## Utiliser une fonction d'un paquet sans le charger

```{r, eval=FALSE}
nommdupackage::nomdelafonction()
```

---

# Comment choisir un paquet ?

--

## Une tache relativement difficile !

--

Utiliser un package permet :

- **de ne pas réinventer la roue**
- de **gagner en productivité**
- de **simplifier son code**

--

Cependant, utiliser un paquet n'est pas exempt de risques :

--

- le paquet peut avoir des bugs (mais vos programmes aussi)

--

- les paquets sont vivants : ils peuvent évoluer dans le temps et votre code peut ne plus fonctionner

--

- le paquet peut disparaître (son auteur ne peut plus ou ne veut plus le maintenir)

--

.recommandation[
* Evaluer le bénéfice apporté par un paquet ;
* Evaluer le risque.
]

---

# Les paquets : un château de cartes ?

--

Utiliser un paquet = ajouter une dépendance

--

Un paquet dépend souvent d'autres paquets...

--

```{r}
tools::package_dependencies("rmarkdown", recursive = TRUE)
```

--

Comment savoir si cet échafaudage peut s'écrouler ?

--

Il faut mener l'enquête...


---

# Les bénéfices des paquets

## Eviter de (mal) coder des tâches complexes

--

### Exemple 1

Tester si un vecteur numérique comprend des nombres pairs

--

- Utiliser `FSA::is_odd()` ?

--

- Ecrire

```{r, eval=FALSE}
is_odd <- function(x) {
  x %% 2 == 0
}
```

---
# Les bénéfices des paquets


Indice :

```{r}
tools::package_dependencies("FSA", recursive = TRUE)
```

---
# Les bénéfices des paquets

### Exemple 2 :

Manipuler des données JSON ou des fichiers XML

- Utiliser les paquets `jsonlite` ou `xml2` ?

--

- Y passer des années pour obtenir un code qui sera buggué ?

--

Indices :

```{r}
tools::package_dependencies("jsonlite", recursive = TRUE)
tools::package_dependencies("xml2", recursive = TRUE)
```

---

# Trouver son chemin

Les CRAN Tasks Views :

- <https://cran.r-project.org/web/views/>
- <https://cran.r-project.org/view=OfficialStatistics>

La liste des logiciels libres utilisés dans la statistique publique :

<https://github.com/SNStatComp/awesome-official-statistics-software>

---

# Se rassurer

### La qualité de la documentation

- les vignettes
- les sites web associés

--

Une marque de soins

--

.conseil[
  Ne pas utiliser de paquet n'ayant ni vignette ni site web associé
]


--

### Facilité d'utilisation

--

A vous de juger !

---

# Se rassurer

### Popularité et communauté d'utilisateurs

Les problèmes des packages confidentiels :

- difficulté à obtenir de l'aide
- présence éventuelle de bugs non détectés
- bonne adéquation à la tâche

.conseil[
Ne pas utiliser de package qui paraisse trop confidentiel.
]

```{r}
with(
  cranlogs::cran_downloads(packages = "ggplot2", when = "last-month"), 
  sum(count)
)
```


Enquêter sur internet, [StackOverflow](https://stackoverflow.com/), [GitHub](https://github.com)...

---

# Se rassurer

Réactivité de la maintenance :
- le facteur d'autobus

Qualité des développements :
- les tests
- les badges de qualimétrie

Réputation des auteurs

Enquêter sur le site de développement (GitHub ou GitLab)

.conseil[
Ne pas utiliser de package qui présente de nombreuses issues restées sans réponse.

Se méfier très fortement des packages n’ayant qu’un seul contributeur.
]

---

.sauterligne3[
La boîte `.sauterligne3[]` sert à sauter trois lignes avant le contenu de la boîte. Saurez-vous deviner à quoi servent les boîtes `.sauterligne[]` `.sauterligne2[]`?
]



--
.sauterligne2[
  Plan de la présentation :
]

- Partie 1: introduction;
- Partie 2: entrée;
- Partie 3: plat de résistance;
- Partie 4: dessert.


---
# Introduction

Voici comment faire des listes, numérotées ou pas.
Le projet `utilitR` est parti de deux constats :

1. Premier point :
  + Sous-point;
    + sous-sous-point 1;
    + sous-sous-point 2;

--

Mettre `--` sur une ligne permet d'afficher progressivement les éléments d'un slide.

2. Deuxième point.

---
# Utiliser ce modèle de présentation

Voici comment exécuter des _chunks_ en affichant le code:

```{r, echo = TRUE, warning = FALSE, eval = TRUE}
1+1
```

Voici comment exécuter des _chunks_ en cachant le code:

```{r, echo = FALSE, warning = FALSE, eval = TRUE}
1+1
```

Voici comment montrer un code sans l'exécuter:

```{r, echo = TRUE, warning = FALSE, eval = FALSE}
1+1
```

---
# Utiliser ce modèle de présentation

Les boîtes `.smallXX[]` permettent de changer facilement la taille des éléments.

.small90[
Les boîtes `.smallXX[]` permettent de changer facilement la taille des éléments.
]

.small80[
Les boîtes `.smallXX[]` permettent de changer facilement la taille des éléments.
]

.small70[
Les boîtes `.smallXX[]` permettent de changer facilement la taille des éléments.
]

.small60[
Les boîtes `.smallXX[]` permettent de changer facilement la taille des éléments.
]

---
# Utiliser ce modèle de présentation

Les boîtes colorées sont également disponibles (et combinales avec les boîtes `smallXX[]`) :

.recommandation[
* Pour importer des données de taille réduite (jusqu'à 1 Go), il est recommandé d'utiliser les fonctions `read_csv()` et `read_delim()` du *package* `readr` ;
* Pour importer des données de taille plus importante (supérieure à 1 Go), il est recommandé d'utiliser la fonction `fread()` du *package* `data.table`.
* L'usage du *package* `csvread` est déconseillé, de même que l'utilisation des fonctions natives de `R` `read.csv()` et `read.delim()`.
]


.small90[
.conseil[
Si vous êtes complètement débutants en `R`, il est recommandé d'utiliser l'utilitaire d'importation de ` RStudio`. Une fois que les données sont correctement importées, vous pourrez copier-coller le code dans votre script `R` et vous familiariser avec les fonctions du *package* `readr`.
]
]


---
# Utiliser ce modèle de présentation

.small80[
.remarque[
Il est nettement plus simple de sélectionner des colonnes avec `fread()` qu'avec les fonctions du *package* `readr`. Il est donc recommandé d'utiliser `fread()` lorsque vous souhaitez sélectionner facilement les colonnes à importer.
]
]

.small70[
.specificite[
Une forge interne `GitLab` est accessible depuis AUS. Son adresse, ainsi que des éléments complémentaires à cette fiche, sont disponibles dans la documentation AUS (`Y:/Documentation/AUSV3/`).
]
]

---
# Utiliser ce modèle de présentation

Voici comment afficher le code d'un chunk puis son résultat, en deux temps.

```{r, echo = FALSE}
# On augmente le nombre de lignes imprimées pour faire apparaître deux catégories
options(tibble.print_min = 6)
options(tibble.print_max = 6)
options(dplyr.print_min  = 6)
options(dplyr.print_max  = 6)
```

```{r, echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE}
library(doremifasolData)
library(magrittr)
library(dplyr)

nombre <- doremifasolData::bpe_ens_2018 %>%
  as_tibble() %>%
  filter(TYPEQU == "B316") %>%
  group_by(DEP) %>%
  summarise(nombre_station_serv = sum(NB_EQUIP, na.rm = TRUE))
nombre
```

--

```{r, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}
library(doremifasolData)
library(magrittr)
library(dplyr)

nombre <- doremifasolData::bpe_ens_2018 %>%
  as_tibble() %>%
  filter(TYPEQU == "B316") %>%
  group_by(DEP) %>%
  summarise(nombre_station_serv = sum(NB_EQUIP, na.rm = TRUE))
nombre
```

---

background-image: url('resources/logo-utilitr.png')
background-size: 7cm
background-position: 8.5cm 3cm

# Merci !


